Пошаговая логика работы этапов работ из ProductCard (с момента загрузки страницы)
ШАГ 1: Загрузка страницы браузером
1.1. Пользователь открывает страницу проекта (например, через ProjectCard или ProjectsList)
1.2. Пользователь выбирает изделие и открывает ProductCard
1.3. Компонент ProductCard получает пропсы:
ШАГ 2: Инициализация компонента ProductCard
2.1. React создает экземпляр компонента ProductCard
2.2. Инициализируются состояния:
2.3. Инициализируются сенсоры для drag-and-drop:
ШАГ 3: Первый useEffect — синхронизация productId
3.1. Выполняется первый useEffect:
3.2. Если productId не начинается с temp-, устанавливается isNewProduct = false
ШАГ 4: Второй useEffect — загрузка данных
4.1. Выполняется второй useEffect:
4.2. Условие выполнено → вызывается fetchStages()
ШАГ 5: Функция fetchStages() — запрос к API
5.1. Внутри fetchStages():
5.2. Формируется HTTP-запрос:
5.3. Отправка запроса на сервер
ШАГ 6: API обрабатывает запрос (на сервере)
6.1. API эндпоинт: GET /projects/products/:productId/work-stages
6.2. Prisma запрос:
6.3. Сервер возвращает JSON-массив этапов, отсортированных по orderIndex: 'asc'
ШАГ 7: Обработка ответа от API
7.1. Получение ответа:
7.2. Обновление состояния:
7.3. Пример структуры data:
ШАГ 8: React перерисовывает компонент
8.1. После setStages(data) React видит изменение состояния
8.2. Компонент перерисовывается с новыми данными
8.3. Рендерится вкладка "Этапы работ":
ШАГ 9: Создание SortableContext
9.1. Создается SortableContext:
9.2. items — массив ID этапов в текущем порядке из массива stages
ШАГ 10: Рендер строк таблицы
10.1. Рендерятся строки:
10.2. Для каждого этапа создается SortableStageRow:
key={stage.id} — React использует ID как ключ
Порядок берется из массива stages
10.3. Каждая строка отображает:
Иконку перетаскивания (DragIndicator)
Вид работ
Исполнителя
Сумму, часы, даты и т.д.
ШАГ 11: Инициализация SortableStageRow
11.1. Для каждой строки вызывается useSortable:
11.2. dnd-kit регистрирует элемент как перетаскиваемый
11.3. Применяются стили:
ШАГ 12: Готово к использованию
12.1. Страница полностью загружена
12.2. Этапы отображаются в таблице в порядке из базы данных
12.3. Каждый этап можно перетаскивать за иконку DragIndicator
ШАГ 13: Перетаскивание этапа (когда пользователь перетаскивает)
13.1. Пользователь начинает перетаскивание:
Нажимает на иконку DragIndicator
Перемещает мышь
13.2. PointerSensor отслеживает движение (активация после 10px)
13.3. Применяется transform для визуального перемещения карточки
13.4. При отпускании вызывается handleDragEnd
ШАГ 14: handleDragEnd — обработка перетаскивания
14.1. Получение active и over:
14.2. Поиск индексов в массиве stages:
14.3. Перестановка в массиве:
14.4. Обновление состояния:
ШАГ 15: React перерисовывает с новым порядком
15.1. После setStages(newStages) React видит изменение
15.2. stages.map() создает новый массив элементов в новом порядке
15.3. React сравнивает элементы по key={stage.id} и перемещает их в DOM
15.4. dnd-kit применяет анимацию через transition
ШАГ 16: Сохранение на сервер
16.1. Формирование данных для API:
16.2. Отправка запроса:
16.3. Сервер обновляет orderIndex в базе данных
16.4. При ошибке — откат через fetchStages()
Вот полная последовательность с момента загрузки страницы до сохранения изменений.